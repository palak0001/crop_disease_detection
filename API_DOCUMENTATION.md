# AgroGuard AI - API Documentation

## Base URL
```
http://localhost:8000
```

## Authentication
All protected endpoints require a Bearer token in the Authorization header:
```
Authorization: Bearer {token}
```

---

## Authentication Endpoints

### Register User
**POST** `/register`

Create a new user account.

**Request Body:**
```json
{
  "email": "user@example.com",
  "username": "username",
  "password": "password123"
}
```

**Response (201 Created):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "username": "username"
}
```

**Error Responses:**
- 400: Email already registered
- 400: Registration failed

---

### Login User
**POST** `/login`

Authenticate user and obtain JWT token.

**Request Body:**
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "username": "username"
}
```

**Error Responses:**
- 401: Invalid email or password
- 400: Login failed

---

## Prediction Endpoints

### Make Prediction
**POST** `/predict`

Upload an image and get disease prediction.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**Request Body:**
- `file`: Image file (JPG, PNG, GIF, WebP)

**Response (200 OK):**
```json
{
  "predicted_class": "Potato___Early_blight",
  "predicted_class_display": "Potato Early Blight",
  "confidence": 0.9876,
  "treatment": "Remove affected leaves, improve air circulation, apply fungicide...",
  "medicine": "Mancozeb",
  "prediction_id": 1
}
```

**Error Responses:**
- 400: Invalid image file
- 401: Unauthorized
- 500: Prediction failed

---

### Get User Predictions
**GET** `/predictions`

Retrieve all predictions made by the current user.

**Headers:**
```
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "total": 5,
  "predictions": [
    {
      "id": 1,
      "user_id": 1,
      "image_name": "leaf.jpg",
      "predicted_class": "Potato___Early_blight",
      "confidence": 0.9876,
      "treatment": "Remove affected leaves...",
      "medicine": "Mancozeb",
      "created_at": "2024-02-11 10:30:00"
    },
    ...
  ]
}
```

**Error Responses:**
- 401: Unauthorized
- 400: Failed to fetch predictions

---

### Get User Statistics
**GET** `/user-stats`

Get aggregated statistics about user's predictions.

**Headers:**
```
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "total_predictions": 10,
  "most_common_disease": "Tomato___Early_blight",
  "disease_counts": {
    "Tomato___Early_blight": 4,
    "Potato___Late_blight": 3,
    "Pepper__bell___Bacterial_spot": 2,
    "Tomato___healthy": 1
  }
}
```

**Error Responses:**
- 401: Unauthorized
- 400: Failed to fetch stats

---

## Report Endpoints

### Generate Report
**POST** `/generate-report/{prediction_id}`

Generate a PDF report for a specific prediction.

**Headers:**
```
Authorization: Bearer {token}
```

**Path Parameters:**
- `prediction_id` (integer): ID of the prediction

**Response (200 OK):**
```json
{
  "success": true,
  "report_id": 5,
  "filename": "report_20240211_103000.pdf",
  "message": "Report generated successfully"
}
```

**Error Responses:**
- 404: Prediction not found
- 403: Unauthorized access to prediction
- 400: Report generation failed

---

### Get User Reports
**GET** `/reports`

Retrieve all reports generated by the current user.

**Headers:**
```
Authorization: Bearer {token}
```

**Response (200 OK):**
```json
{
  "success": true,
  "reports": [
    {
      "id": 1,
      "user_id": 1,
      "prediction_id": 1,
      "file_path": "static/reports/report_20240211_103000.pdf",
      "predicted_class": "Potato___Early_blight",
      "confidence": 0.9876,
      "created_at": "2024-02-11 10:32:15"
    },
    ...
  ]
}
```

**Error Responses:**
- 401: Unauthorized
- 400: Failed to fetch reports

---

### Download Report
**GET** `/download-report/{report_id}`

Download a PDF report file.

**Headers:**
```
Authorization: Bearer {token}
```

**Path Parameters:**
- `report_id` (integer): ID of the report

**Response (200 OK):**
- Binary PDF file

**Error Responses:**
- 404: Report not found
- 403: Unauthorized access
- 400: Download failed

---

## Utility Endpoints

### Health Check
**GET** `/health`

Check if the API is running.

**Response (200 OK):**
```json
{
  "status": "healthy",
  "timestamp": "2024-02-11T10:30:00"
}
```

---

### API Info
**GET** `/`

Get API information.

**Response (200 OK):**
```json
{
  "message": "Welcome to AgroGuard AI",
  "version": "1.0.0",
  "docs": "/docs"
}
```

---

## Supported Disease Classes

### Potato
- `Potato___Early_blight` - Potato Early Blight
- `Potato___healthy` - Healthy Potato
- `Potato___Late_blight` - Potato Late Blight

### Tomato
- `Tomato___Bacterial_spot` - Tomato Bacterial Spot
- `Tomato___Early_blight` - Tomato Early Blight
- `Tomato___healthy` - Healthy Tomato
- `Tomato___Late_blight` - Tomato Late Blight
- `Tomato___Leaf_Mold` - Tomato Leaf Mold
- `Tomato___Septoria_leaf_spot` - Tomato Septoria Leaf Spot
- `Tomato___Spider_mites_Two_spotted_spider_mite` - Tomato Spider Mites
- `Tomato___Target_Spot` - Tomato Target Spot
- `Tomato___Tomato_mosaic_virus` - Tomato Mosaic Virus
- `Tomato___Tomato_YellowLeaf__Curl_Virus` - Tomato Yellow Leaf Curl Virus

### Bell Pepper
- `Pepper__bell___Bacterial_spot` - Bell Pepper Bacterial Spot
- `Pepper__bell___healthy` - Healthy Bell Pepper

---

## Rate Limiting

No rate limiting is implemented in development mode. For production, consider:
- Implementing rate limiting per user/IP
- Using Redis for token caching
- Adding request throttling

---

## CORS Configuration

Currently allows all origins (`*`). For production:

Update in `main.py`:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["https://yourdomain.com"],
    allow_credentials=True,
    allow_methods=["GET", "POST"],
    allow_headers=["*"],
)
```

---

## Error Handling

All errors follow this format:

```json
{
  "detail": "Error message description"
}
```

Common HTTP Status Codes:
- `200 OK` - Request successful
- `201 Created` - Resource created
- `400 Bad Request` - Invalid request
- `401 Unauthorized` - Missing/invalid token
- `403 Forbidden` - Access denied
- `404 Not Found` - Resource not found
- `500 Internal Server Error` - Server error

---

## Example Usage with cURL

### Register
```bash
curl -X POST "http://localhost:8000/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "username": "testuser",
    "password": "password123"
  }'
```

### Login
```bash
curl -X POST "http://localhost:8000/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

### Make Prediction
```bash
curl -X POST "http://localhost:8000/predict" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@path/to/image.jpg"
```

### Get Predictions
```bash
curl -X GET "http://localhost:8000/predictions" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Generate Report
```bash
curl -X POST "http://localhost:8000/generate-report/1" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## Interactive API Documentation

Access the interactive API documentation at:
- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

These interfaces allow you to test all endpoints directly from your browser.
